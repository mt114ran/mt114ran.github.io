name: Copilot Issue Solver

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: read

jobs:
  solve-with-copilot:
    # /copilot ã¾ãŸã¯ /solve ã‚³ãƒãƒ³ãƒ‰ã§èµ·å‹•
    if: |
      github.event.issue.pull_request == null &&
      (startsWith(github.event.comment.body, '/copilot') || startsWith(github.event.comment.body, '/solve'))
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ¯ React to comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });
      
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ”§ Setup environment
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: ğŸ“¦ Install GitHub CLI with Copilot
        run: |
          # Copilot CLIã®ç¢ºèªã¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          gh extension list | grep copilot || gh extension install github/gh-copilot
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ¤– Generate solution with Copilot
        id: generate
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          # ã‚³ãƒ¡ãƒ³ãƒˆã‹ã‚‰æŒ‡ç¤ºã‚’æŠ½å‡ºï¼ˆç’°å¢ƒå¤‰æ•°ã‹ã‚‰å®‰å…¨ã«å–å¾—ï¼‰
          INSTRUCTION=$(echo "$COMMENT_BODY" | sed 's/^\/[a-z]*//')
          ISSUE_NUMBER=${{ github.event.issue.number }}
          
          echo "ğŸ“‹ Processing Issue #$ISSUE_NUMBER: $ISSUE_TITLE"
          
          # Copilotã§è§£æ±ºç­–ã‚’ç”Ÿæˆï¼ˆæ—¥æœ¬èªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰
          cat > copilot_prompt.txt << EOF
          ã€é‡è¦ã€‘ã“ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«ã¯æ—¥æœ¬èªã§å›ç­”ã—ã¦ãã ã•ã„ã€‚ã‚³ãƒ¡ãƒ³ãƒˆã‚‚æ—¥æœ¬èªã§ãŠé¡˜ã„ã—ã¾ã™ã€‚
          
          GitHub Issue #$ISSUE_NUMBER: $ISSUE_TITLE
          
          èª²é¡Œã®èª¬æ˜:
          $ISSUE_BODY
          
          ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦æ±‚:
          $INSTRUCTION
          
          ä»¥ä¸‹ã‚’æ—¥æœ¬èªã§æä¾›ã—ã¦ãã ã•ã„ï¼š
          1. å®Œå…¨ãªå®Ÿè£…ã‚³ãƒ¼ãƒ‰ï¼ˆæ—¥æœ¬èªã‚³ãƒ¡ãƒ³ãƒˆä»˜ãï¼‰
          2. ã‚³ãƒ¼ãƒ‰ã‚’ä¿å­˜ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
          3. å¿…è¦ãªãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰
          4. è§£æ±ºç­–ã®ç°¡æ½”ãªèª¬æ˜
          
          ä»¥ä¸‹ã®å½¢å¼ã§ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’æ˜ç¢ºã«ç¤ºã—ã¦ãã ã•ã„ï¼š
          ### File: src/example.ts
          \`\`\`typescript
          // æ—¥æœ¬èªã®ã‚³ãƒ¡ãƒ³ãƒˆ
          // å®Ÿè£…ã‚³ãƒ¼ãƒ‰
          \`\`\`
          EOF
          
          # Copilot CLIã§è§£æ±ºç­–ã‚’ç”Ÿæˆï¼ˆæ—¥æœ¬èªå¯¾å¿œï¼‰
          export LANG=ja_JP.UTF-8
          export LC_ALL=ja_JP.UTF-8
          export LANGUAGE=ja_JP:ja
          
          # Copilot CLIã‚’ç›´æ¥å®Ÿè¡Œï¼ˆæ—¥æœ¬èªã‚’æ˜ç¤ºçš„ã«æŒ‡å®šï¼‰
          echo "æ—¥æœ¬èªã§å›ç­”ã—ã¦ãã ã•ã„: $(cat copilot_prompt.txt)" | gh copilot suggest > solution.md 2>&1 || {
            echo "âš ï¸ Copilot CLI response failed, using alternative method..."
            echo "Error output:"
            cat solution.md
            
            # ä»£æ›¿: æ—¥æœ¬èªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ™ãƒ¼ã‚¹ã®è§£æ±ºç­–
            cat > solution.md << 'FALLBACK'
          ## ğŸ¤– è§£æ±ºç­–ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
          
          Issueè¦ä»¶ã«åŸºã¥ã„ã¦ã€ä»¥ä¸‹ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’ææ¡ˆã—ã¾ã™ï¼š
          
          ### File: src/solution.ts
          ```typescript
          // TODO: Issue #${{ github.event.issue.number }}ã®è§£æ±ºç­–ã‚’å®Ÿè£…
          // ã‚¿ã‚¤ãƒˆãƒ«: ${{ github.event.issue.title }}
          
          export function solution() {
            // ã“ã“ã«å®Ÿè£…ã‚’è¨˜è¿°
            // VS Codeã§Copilotã‚’ä½¿ç”¨ã—ã¦è‡ªå‹•è£œå®Œã‚’æ´»ç”¨ã—ã¦ãã ã•ã„
          }
          ```
          
          ### File: src/solution.test.ts
          ```typescript
          import { solution } from './solution';
          
          describe('Issue #${{ github.event.issue.number }}ã®è§£æ±ºç­–', () => {
            it('æœŸå¾…é€šã‚Šã«å‹•ä½œã™ã‚‹ã“ã¨', () => {
              // ãƒ†ã‚¹ãƒˆã®å®Ÿè£…
            });
          });
          ```
          FALLBACK
          }
          
          # è§£æ±ºç­–ã‚’Issueã«ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆæ—¥æœ¬èªï¼‰
          {
            echo "## ğŸ¤– Copilotç”Ÿæˆã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³"
            echo ""
            echo "ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«åŸºã¥ã„ã¦ã€ä»¥ä¸‹ã®è§£æ±ºç­–ã‚’ææ¡ˆã—ã¾ã™ï¼š"
            echo ""
            cat solution.md
            echo ""
            echo "---"
            echo "### ğŸ“ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼š"
            echo "1. ææ¡ˆã•ã‚ŒãŸã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼"
            echo "2. æ‰¿èªã™ã‚‹å ´åˆã¯ğŸ‘ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦PRã‚’è‡ªå‹•ä½œæˆ"
            echo "3. ã¾ãŸã¯æ‰‹å‹•ã§ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦å®Ÿè£…"
            echo ""
            echo "*GitHub Copilotã«ã‚ˆã‚Šç”Ÿæˆ â€¢ PRã‚’ä½œæˆã™ã‚‹ã«ã¯ \`/apply\` ã¨è¿”ä¿¡*"
          } > comment.md
          
          gh issue comment $ISSUE_NUMBER --body-file comment.md
      
      - name: ğŸ“Š Parse solution and create files
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // solution.mdã‚’èª­ã¿è¾¼ã¿
            const solution = fs.readFileSync('solution.md', 'utf8');
            
            // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã¨ã‚³ãƒ¼ãƒ‰ã‚’æŠ½å‡º
            const fileRegex = /### File: ([^\n]+)/g;
            const codeBlockRegex = /```(?:\w+)?\n([\s\S]*?)```/g;
            
            const files = [];
            let fileMatch;
            const filePaths = [];
            
            while ((fileMatch = fileRegex.exec(solution)) !== null) {
              filePaths.push(fileMatch[1].trim());
            }
            
            const codeBlocks = [];
            let codeMatch;
            while ((codeMatch = codeBlockRegex.exec(solution)) !== null) {
              codeBlocks.push(codeMatch[1]);
            }
            
            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
            let changesDetected = false;
            for (let i = 0; i < Math.min(filePaths.length, codeBlocks.length); i++) {
              const filePath = filePaths[i];
              const code = codeBlocks[i];
              
              if (filePath && code) {
                const dir = path.dirname(filePath);
                if (!fs.existsSync(dir)) {
                  fs.mkdirSync(dir, { recursive: true });
                }
                
                fs.writeFileSync(filePath, code);
                console.log(`âœ… Created: ${filePath}`);
                changesDetected = true;
              }
            }
            
            core.setOutput('changes_detected', changesDetected);
      
      - name: ğŸŒ¿ Create branch and commit
        if: steps.parse.outputs.changes_detected == 'true'
        run: |
          # ãƒ–ãƒ©ãƒ³ãƒä½œæˆ
          BRANCH_NAME="copilot-issue-${{ github.event.issue.number }}-${{ github.run_number }}"
          git checkout -b $BRANCH_NAME
          
          # å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
          git config user.name "GitHub Copilot[bot]"
          git config user.email "copilot[bot]@users.noreply.github.com"
          
          git add -A
          git commit -m "ğŸ¤– Implement solution for issue #${{ github.event.issue.number }}
          
          Co-authored-by: ${{ github.event.comment.user.login }} <${{ github.event.comment.user.id }}+${{ github.event.comment.user.login }}@users.noreply.github.com>"
          
          git push -u origin $BRANCH_NAME
          
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_ENV
      
      - name: ğŸ”€ Create Pull Request
        if: steps.parse.outputs.changes_detected == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --title "ğŸ¤– [Copilot] ${{ github.event.issue.title }}" \
            --body "## ğŸ“‹ Overview
          
          This PR implements the solution for #${{ github.event.issue.number }}
          
          ## ğŸ¤– Generated by GitHub Copilot
          
          The solution was automatically generated based on the issue description and user comment.
          
          ## ğŸ“ Changes
          
          - Implemented solution based on issue requirements
          - Added necessary files and code
          
          ## ğŸ”— Related Issue
          
          Closes #${{ github.event.issue.number }}
          
          ## ğŸ‘¤ Triggered by
          
          @${{ github.event.comment.user.login }}
          
          ## âœ… Checklist
          
          - [ ] Code review
          - [ ] Tests pass
          - [ ] Documentation updated
          
          ---
          
          *This PR was automatically generated using GitHub Copilot*" \
            --head ${{ env.branch_name }} \
            --base main
      
      - name: âŒ Handle no changes
        if: steps.parse.outputs.changes_detected != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## â„¹ï¸ ã‚³ãƒ¼ãƒ‰å¤‰æ›´ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ
            
            Copilotã®ææ¡ˆã¯ä½œæˆã•ã‚Œã¾ã—ãŸãŒã€å®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚
            
            **å¯¾å‡¦æ–¹æ³•:**
            1. ä¸Šè¨˜ã®ææ¡ˆã•ã‚ŒãŸã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç¢ºèª
            2. ææ¡ˆã•ã‚ŒãŸã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’æ‰‹å‹•ã§å®Ÿè£…
            3. ã¾ãŸã¯ã‚ˆã‚Šå…·ä½“çš„ãªã‚³ãƒãƒ³ãƒ‰ã‚’è©¦ã—ã¦ãã ã•ã„ï¼š
               \`/copilot src/utils.tsã«reverseStringã¨ã„ã†TypeScripté–¢æ•°ã‚’ä½œæˆ\`
            
            ---
            *ãƒ’ãƒ³ãƒˆ: ã‚ˆã‚Šè‰¯ã„çµæœã‚’å¾—ã‚‹ãŸã‚ã«ã€ãƒ•ã‚¡ã‚¤ãƒ«åã¨å®Ÿè£…ã®è©³ç´°ã‚’å…·ä½“çš„ã«æŒ‡å®šã—ã¦ãã ã•ã„*`
            });